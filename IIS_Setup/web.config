<!-- 
  Este es un archivo de configuración para ejecutar una aplicación Next.js en IIS con iisnode.
  Coloca este archivo en la raíz de tu proyecto en el servidor IIS.
-->
<configuration>
  <system.webServer>
    
    <handlers>
      <!-- 
        Este manejador le dice a IIS que todas las solicitudes deben ser procesadas por iisnode.
        El 'path' apunta al script de servidor de Next.js, que es el punto de entrada para la aplicación en modo producción.
      -->
      <add name="iisnode" path="node_modules/next/dist/server/next-server.js" verb="*" modules="iisnode" />
    </handlers>
    
    <rewrite>
      <rules>
        <!-- 
          Regla 1: No reescribir las rutas de la API de Next.js.
          Las solicitudes a /api/... deben ser manejadas directamente por el servidor de Next.js sin reescritura.
        -->
        <rule name="next-api" stopProcessing="true">
          <match url="^api/.*" />
          <action type="None" />
        </rule>

        <!-- 
          Regla 2: No reescribir las rutas de archivos estáticos y de compilación de Next.js.
          Estos archivos (JS, CSS, imágenes) son servidos directamente.
        -->
        <rule name="next-static" stopProcessing="true">
            <match url="^.*/_next/static/.*" />
            <action type="None" />
        </rule>
        
        <!-- 
          Regla 3: Enviar todas las demás solicitudes al servidor de Next.js.
          Esta es la regla principal que permite el enrutamiento de páginas de Next.js.
        -->
        <rule name="next-pages">
          <match url=".*" />
          <action type="Rewrite" url="node_modules/next/dist/server/next-server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      Opcional: Opciones de depuración para iisnode.
      Descomenta esta sección si necesitas diagnosticar problemas.
      - loggingEnabled: Crea archivos de log en una carpeta 'iisnode' dentro de tu sitio.
      - devErrorsEnabled: Muestra errores más detallados en el navegador.
      - nodeProcessCommandLine: Asegúrate de que la ruta al ejecutable de node.exe sea correcta.
    -->
    <!--
    <iisnode
      loggingEnabled="true"
      devErrorsEnabled="true"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
    />
    -->
    
  </system.webServer>
</configuration>
