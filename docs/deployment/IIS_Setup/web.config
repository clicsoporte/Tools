<!--
    v2.0.1
    Optimized for Next.js 14+ on IIS with iisnode.
    
    CRITICAL FIXES in this version:
    - Added a rule to ignore the /dbs/ directory. This prevents iisnode from restarting
      the application every time an SQLite database file (.db) is modified, which was
      a major source of instability.
    - Added a custom interceptor (iisnode-interceptor.js) to fix 404 errors on
      client-side routes by returning a 200 status, letting the Next.js router handle it.
    - Disabled file watching for .env.local to prevent restarts on credential changes.
-->
<configuration>
  <system.webServer>

    <!-- 
        iisnode Configuration: Tells IIS how to run the Node.js application.
        - node_env: Sets the environment to production for optimal performance.
        - watchedFiles: Specifies files that, when changed, will trigger a restart.
                        Crucially, we've removed '*.db' from this list.
        - devErrorsEnabled: Set to false for production to avoid leaking error details.
        - loggingEnabled: Keeps logging on to capture stdout/stderr in the 'iisnode' folder.
        - debuggingEnabled: Should be false in production.
    -->
    <iisnode
      node_env="production"
      watchedFiles="web.config;*.js;*.mjs"
      devErrorsEnabled="false"
      loggingEnabled="true"
      debuggingEnabled="false"
      interceptor="docs\deployment\IIS_Setup\iisnode-interceptor.js" />
      
    <!-- 
        URL Rewrite Module: This is the core of making Next.js work on IIS.
        It defines how incoming requests are processed.
    -->
    <rewrite>
      <rules>
        <!-- Rule 1: Static Files -->
        <!-- Don't apply any rules to static files in the .next/static directory -->
        <rule name="static" stopProcessing="true">
          <match url="^(.next/static.*)" />
          <action type="None" />
        </rule>

        <!-- Rule 2: Dynamic Routes -->
        <!-- All other requests are routed to the Next.js server entry point (server.js) -->
        <rule name="app" stopProcessing="true">
          <match url="/*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
        Security: Request Filtering
        - hiddenSegments: Prevents direct web access to sensitive folders.
          We've added 'dbs' to this list to block any direct download attempts
          of the database files.
    -->
    <security>
        <requestFiltering>
            <hiddenSegments>
                <add segment="node_modules" />
                <add segment="iisnode" />
                <add segment="dbs" />
            </hiddenSegments>
        </requestFiltering>
    </security>

  </system.webServer>
</configuration>
