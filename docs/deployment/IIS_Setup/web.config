<!-- 
    This file is the configuration for running the Next.js application on Windows Server with IIS and the `iisnode` module.
    It is pre-configured to handle server-side rendering, client-side routing, and to prevent unexpected restarts.
-->
<configuration>
  <system.webServer>

    <!-- 
      iisnode is the core handler that tells IIS how to run Node.js applications.
      - node_env="production" sets the Node.js environment to production mode.
      - watchedFiles="*.js;iisnode-interceptor.js" tells iisnode to ONLY restart the app if these files change.
        CRITICALLY, this prevents restarts when files in `dbs/`, `public/`, or `.next/` are modified.
      - loggingEnabled="true" will create a folder named `iisnode` in your app's root with logs, invaluable for debugging.
    -->
    <iisnode 
      node_env="production" 
      watchedFiles="*.js;iisnode-interceptor.js" 
      loggingEnabled="true"
      interceptor="docs/deployment/IIS_Setup/iisnode-interceptor.js"
    />

    <!--
      This handler tells IIS to pass all incoming requests to the iisnode module.
      The `path="*"` means all URLs will be handled by Node.js.
    -->
    <handlers>
      <add name="iisnode" path="*.js" verb="*" modules="iisnode" />
    </handlers>

    <!-- 
      URL Rewrite rules are essential for a Next.js app on IIS.
      - The first rule is for Server-Side Rendering (SSR). It rewrites all incoming requests (except for static files) 
        to the `server.js` file, which is the entry point of the compiled Next.js application.
      - The second rule is a safeguard. If a request would normally result in a 404 Not Found error, this rule
        prevents IIS from showing its own 404 page and instead lets the Next.js app handle the routing,
        which is crucial for client-side navigation.
    -->
    <rewrite>
      <rules>
        <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
          <match url="^server.js\/debug[\/]?" />
        </rule>
        
        <rule name="next-js">
          <match url="/*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      This section is added to increase the maximum allowed URL and query string length.
      This can be useful for complex client-side routes or applications that use large search parameters.
    -->
    <security>
      <requestFiltering>
        <requestLimits maxUrl="4096" maxQueryString="2048" />
      </requestFiltering>
    </security>

  </system.webServer>
</configuration>
