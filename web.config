<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>

    <!-- Manejador para iisnode -->
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <!--
      Reglas de reescritura de URL para enrutar todo a Next.js (server.js),
      excepto las rutas que iisnode ya gestiona y los archivos estáticos.
    -->
    <rewrite>
      <rules>
        <!-- No reescribir rutas que ya están siendo manejadas por iisnode -->
        <rule name="iisnode-inspector" patternSyntax="ECMAScript" stopProcessing="true">
          <match url="^server.js\/debug[\/]?" />
        </rule>

        <!-- Servir archivos estáticos de Next.js directamente desde IIS para mejor rendimiento -->
        <rule name="NextJs_Static" stopProcessing="true">
          <match url="^(\_next\/.+)" />
          <action type="Rewrite" url="{R:1}" />
        </rule>
        
        <!-- Enrutar todo lo demás a la aplicación Next.js -->
        <rule name="NextJs_Dynamic">
          <match url="/*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!--
      Configuración de seguridad para aumentar el límite de tamaño de las peticiones.
      El valor está en bytes. 52428800 = 50 MB.
    -->
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="52428800" />
      </requestFiltering>
    </security>

    <!-- Configuración para iisnode -->
    <iisnode
      node_env="production"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      interceptor="&quot;%~dp0\docs\deployment\iisnode-interceptor.js&quot;"
      loggingEnabled="true"
      logDirectory="iisnode"
      debuggingEnabled="false"
      devErrorsEnabled="false"
    />

  </system.webServer>
</configuration>
