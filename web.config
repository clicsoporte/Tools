<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <!-- This handler is for Next.js 14+ with iisnode -->
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>
    <rewrite>
      <rules>
        <!-- Rule to serve static files directly from IIS for better performance -->
        <rule name="StaticContent" stopProcessing="true">
            <match url="^static\/(.*)" ignoreCase="true" />
            <action type="Rewrite" url="public/static/{R:1}" />
        </rule>
        <rule name="NextJs">
          <match url="/*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>
    <!-- 
      This iisnode configuration is CRITICAL.
      - watchedFiles: Tells iisnode what to monitor for restarts. 
        Crucially, we EXCLUDE the `dbs` folder by not listing it. 
        This prevents the "aborted" error when the database is written to.
      - nodeProcessCommandLine: Ensures the correct Node.js executable is used.
    -->
    <iisnode 
      loggingEnabled="true"
      watchedFiles="web.config;iisnode.yml;*.js"
      devErrorsEnabled="true"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      interceptor="iisnode-interceptor.js"
    />
  </system.webServer>
</configuration>
