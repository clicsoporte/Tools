<!-- 
    This configuration file is required for running a Next.js app on IIS using iisnode.
    It tells IIS how to handle incoming requests and rewrite URLs so that they are correctly
    processed by the Next.js server running in Node.js.
-->
<configuration>
  <system.webServer>
    <!-- 
      The iisnode handler maps requests to the Node.js application.
      The watchedFiles attribute is critical to prevent the app from restarting every time
      a non-code file (like a database) is written to. We only watch for code changes.
    -->
    <iisnode node_env="production" watchedFiles="*.js;*.mjs" />

    <!-- 
      URL Rewrite rules are essential for Next.js to handle routing correctly.
      1. Serves static Next.js assets (_next/*) directly for performance.
      2. Rewrites all other requests to the Node.js server (server.js).
    -->
    <rewrite>
      <rules>
        <!-- Rule 1: Serve Next.js static assets directly from the filesystem -->
        <rule name="NextJs_Static" stopProcessing="true">
          <match url="^.*" />
          <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
              <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
              <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="_next{REQUEST_URI}" appendQueryString="true" />
        </rule>
        
        <!-- Rule 2: Rewrite all other requests to the Next.js server entry point -->
        <rule name="NextJs_Rewrite">
          <match url="^.*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      Ensure that the iisnode module is listed as a handler.
      This might be automatically configured at the server level but is included here for completeness.
    -->
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>
    
  </system.webServer>
</configuration>
