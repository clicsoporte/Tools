<!-- 
  Este archivo de configuración está optimizado para Next.js 14+ en IIS.
  - Utiliza URL Rewrite para enrutar las solicitudes a iisnode.
  - Permite que IIS sirva archivos estáticos directamente para un mejor rendimiento.
  - Incluye límites de tamaño de solicitud aumentados para manejar Server Actions grandes.
-->
<configuration>
  <!-- 
    Sección para el runtime de ASP.NET legacy. 
    maxRequestLength se mide en kilobytes.
  -->
  <system.web>
    <httpRuntime maxRequestLength="51200" />
  </system.web>

  <system.webServer>
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!-- No reescribir las rutas de la API de Next.js -->
        <rule name="NextAPIs" stopProcessing="true">
          <match url="^api/.*" />
          <action type="None" />
        </rule>

        <!-- No reescribir las rutas internas de Next.js -->
        <rule name="NextInternal" stopProcessing="true">
          <match url="^.next/.*" />
          <action type="None" />
        </rule>
        
        <!-- Reenviar todas las demás solicitudes a Next.js (iisnode) -->
        <rule name="NextRoutes">
          <match url=".*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <iisnode
      loggingEnabled="true"
      logDirectory="iisnode"
      debuggingEnabled="true"
      devErrorsEnabled="true"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
    />

    <!-- Límites de seguridad para el servidor web IIS -->
    <security>
      <requestFiltering>
        <!-- 
          Límite de tamaño del contenido de la solicitud en BYTES.
          El valor por defecto es 30000000 (aprox. 30 MB).
          Lo aumentamos a 50 MB para permitir Server Actions con mucho contenido.
        -->
        <requestLimits maxAllowedContentLength="52428800" />
      </requestFiltering>
    </security>

    <!-- 
      CONFIGURACIÓN CRÍTICA PARA PETICIONES GRANDES:
      Aumenta el buffer de lectura de IIS para que no rechace peticiones
      cuyo cuerpo sea más grande que el límite por defecto (49 KB).
      Este valor también se establece en bytes (50 MB).
    -->
    <serverRuntime uploadReadAheadSize="52428800" />

  </system.webServer>
</configuration>
