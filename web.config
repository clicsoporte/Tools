<!--
====================================================================================================
Este archivo de configuración está optimizado para Next.js 14+ en IIS con iisnode.
Funcionalidades clave:
1.  **Reescritura de URL:** Dirige todas las solicitudes que no son archivos estáticos al servidor de Next.js.
2.  **Servicio de Archivos Estáticos:** Permite que IIS sirva directamente los archivos de la carpeta `_next/static`, 
    lo que descarga a Node.js y mejora significativamente el rendimiento.
3.  **Configuración de iisnode:** Define el punto de entrada del servidor de Next.js y habilita el logging.
====================================================================================================
-->
<configuration>
  <system.webServer>
    <handlers>
      <!-- Indica que iisnode debe manejar las solicitudes que se le pasan. -->
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!-- Regla 1: No reescribir las solicitudes para los archivos estáticos de Next.js -->
        <rule name="NextStatics" stopProcessing="true">
          <match url="^(_next|favicon.ico)(.*)" />
          <action type="None" />
        </rule>

        <!-- Regla 2: Reescribir todas las demás solicitudes al servidor de Next.js -->
        <rule name="NextRoutes" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      Asegúrate de tener instalado el módulo de reescritura de URL (URL Rewrite) en IIS.
      Descárgalo desde: https://www.iis.net/downloads/microsoft/url-rewrite
    -->
    
    <security>
      <requestFiltering>
        <hiddenSegments>
          <!-- Previene el acceso público a carpetas sensibles. -->
          <add segment="node_modules" />
          <add segment="dbs" />
          <add segment=".next" />
        </hiddenSegments>
      </requestFiltering>
    </security>

    <!-- 
      Configuración de iisnode.
      - `node_env=production` asegura que Next.js se ejecute en modo producción.
      - `loggingEnabled` crea archivos de log en la carpeta `iisnode` para depuración.
      - `interceptor` apunta a un script para manejo avanzado de respuestas (ver iisnode-interceptor.js).
    -->
    <iisnode
      node_env="production"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      interceptor="&quot;%programfiles%\nodejs\node.exe&quot; iisnode-interceptor.js"
      loggingEnabled="true"
      logDirectory="iisnode"
      debuggingEnabled="false"
    />
  </system.webServer>
</configuration>
